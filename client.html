<!-- client.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Player</title>
    <style>
        /* Ensure full screen for the iframe */
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        #youtube-client {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        #progress-bar-container {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            max-width: 100%;
            height: 10px;
            background-color: #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        #progress-bar span {
            display: block;
            height: 100%;
            background-color: #007BFF;
            border-radius: 5px;
            width: 0%;
        }
    </style>
</head>

<body>

    <div id="youtube-client">
        <!-- YouTube iframe embed -->
        <iframe id="youtube-iframe" src="https://www.youtube.com/embed/rdorzAplV3M?enablejsapi=1&rel=0" frameborder="0"
            allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
        </iframe>
        <div id="error-message" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(220, 53, 69, 0.95); color: white; padding: 30px; border-radius: 10px; text-align: center; font-size: 18px; max-width: 400px; z-index: 1000;">
            <h3>⚠️ Video non disponibile</h3>
            <p>Il video non può essere caricato perché l'uploader non consente l'incorporamento in altri siti.</p>
        </div>
    </div>

    <script>
        // Function that is called when the YouTube Iframe API is ready
        function onYouTubeIframeAPIReady() {
            window.player = new YT.Player('youtube-iframe', {
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
            console.log(window.player);
        }
    </script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let isPlayerReady = false;

        function onPlayerReady(event) {
            isPlayerReady = true;
            channel.postMessage({ type: 'isMuted', isMuted: window.player.isMuted() });
        }

        function onPlayerError(event) {
            // Handle YouTube player errors
            const errorCode = event.data;
            let errorMessage = '';

            switch (errorCode) {
                case 2:
                    errorMessage = 'Parametro non valido';
                    break;
                case 5:
                    errorMessage = 'Errore del player HTML5';
                    break;
                case 100:
                    errorMessage = 'Video non trovato';
                    break;
                case 101:
                case 150:
                    errorMessage = 'Video non incorporabile';
                    break;
                default:
                    errorMessage = 'Errore sconosciuto';
            }

            console.error('Player Error:', errorCode, errorMessage);
            showVideoError(errorMessage);
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING || event.data == YT.PlayerState.PAUSED) {
                // Video is playing or paused successfully - clear any error message
                clearVideoError();
                // Send progress updates to the remote
                setInterval(function () {
                    const currentTime = window.player.getCurrentTime();
                    const duration = window.player.getDuration();
                    const progress = (currentTime / duration) * 100;
                    channel.postMessage({ type: 'progress', time: { currentTime, duration } });
                }, 1000); // Update every second
            }
        }

        function showVideoError(errorType) {
            document.getElementById('error-message').style.display = 'block';
            channel.postMessage({ type: 'error', errorType: errorType });
        }

        function clearVideoError() {
            document.getElementById('error-message').style.display = 'none';
            channel.postMessage({ type: 'error', errorType: false });
        }

        const channel = new BroadcastChannel('youtube_channel');
        // Listen for commands sent from the remote control (Page 2)
        channel.onmessage = function (event) {
            const message = event.data;
            console.log('Received message:', message);

            if (event.data.type === 'ping') {
                // Respond with "pong" when a ping is received
                channel.postMessage({ type: 'pong' });
                if (isPlayerReady) channel.postMessage({ type: 'isMuted', isMuted: window.player.isMuted() });
            } else if (message.type === 'control') {
                console.log(window.player);
                if (!isPlayerReady) return;
                switch (message.command) {
                    case 'play':
                        window.player.playVideo();
                        break;
                    case 'pause':
                        window.player.pauseVideo();
                        break;
                    case 'toggle':
                        if (window.player.getPlayerState() === YT.PlayerState.PLAYING) {
                            window.player.pauseVideo();
                        } else {
                            window.player.playVideo();
                        }
                        break;
                    case 'stop':
                        window.close();
                        break;
                    case 'mute':
                        window.player.mute();
                        break;
                    case 'unmute':
                        window.player.unMute();
                        break;
                    case 'seek':
                        window.player.seekTo((message.time / 100) * window.player.getDuration(), true); // Seek to the percentage
                        break;
                    default:
                        console.log('Unknown command:', message.command);
                        break;
                }
            } else if (message.type === 'video') {
                if (!isPlayerReady) return;
                clearVideoError();
                // Change video source based on new video ID
                window.player.loadVideoById(message.videoId);
            }
        };

        // Ping/Pong functionality
        window.onload = function () {
            // Send an "heartbeat" message every second
            setInterval(function () {
                channel.postMessage({ type: 'hi' });
            }, 1000);
        };
    </script>
</body>

</html>